<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=9" />
	<link rel="stylesheet" type="text/css" href="../css/styles.css" />
	<link rel="stylesheet" type="text/css" href="../css/snippet.css" />
	<script type="text/javascript" src="../scripts/snippet.js"></script>
	<script type="text/javascript" src="../scripts/jquery.util.js" charset="utf-8"></script>
	<script type="text/javascript" src="../scripts/common.js" charset="utf-8"></script>
	<script type="text/javascript" src="../scripts/core.js" charset="utf-8"></script>
	<script type="text/javascript" src="../scripts/search.js" charset="utf-8"></script>

	<title>Files Sharing Server Sample Overview</title>
</head>

<body class="no-toc" onload="prettyPrint()" style="overflow: auto;">

<div id="toc-navigation">
</div>

<div id="container"><div id="contents"><div class="content">
	<div id="profile">
		<p><img alt="Mobile native" src="../images/mobile_s_n.png"/></p>
	</div>

  <h1>Files Sharing Server Sample Overview</h1>

  <p>The Files Sharing Server sample application demonstrates how you can use the <a href="../../../org.tizen.native.mobile.apireference/group__CAPI__NETWORK__BLUETOOTH__OPP__MODULE.html">Bluetooth OPP</a> (Object Push Profile) API to receive files from other devices.</p>
  <p>For information on creating the sample application project in the IDE, see <a href="../cover_page.htm#create">Creating Sample Applications</a>.</p>
  
  <p>The following figure illustrates the main screen of the Files Sharing Server.</p>
  <p class="figure">Figure: Files Sharing Server screen</p>
  <p align="center"><img alt="Files Sharing Server screen" src="../images/files_sharing_server_main_view.png" />
  </p>

  <h2>Prerequisites</h2>  
  <ul>
  <li>Bluetooth adapter must be switched on.</li>
    <li>Connection with another device must be available.</li>
 <li>To ensure proper application execution, the following privileges must be set:
  <ul>
    <li><span style="font-family: Courier New,Courier,monospace">http://tizen.org/privilege/mediastorage</span></li>
	<li><span style="font-family: Courier New,Courier,monospace">http://tizen.org/privilege/bluetooth</span></li>
	</ul>
	</li>
<li>To ensure proper application execution, the following features must be enabled:
	<ul>
    <li><span style="font-family: Courier New,Courier,monospace">http://tizen.org/feature/network.bluetooth</span></li>
    <li><span style="font-family: Courier New,Courier,monospace">http://tizen.org/feature/network.bluetooth.opp</span></li>
  </ul>
  </li>
  </ul>

<h2>Implementation</h2>
<p>The following figure illustrates the application structure.</p>
<p class="figure">Figure: Sample structure</p>
<p align="center"> <img alt="Sample structure" src="../images/files_sharing_server_structure.png" /></p>
<p>The application uses a simple MVC (Model-View-Controller) architectural pattern. The application model consists of a media and Bluetooth module.</p>

<h3>Controller</h3>
<p>The controller module connects the view and the model. It delivers the following set of functions:</p>
<pre class="prettyprint">
// Function initializes all application modules and event listeners
bool 
controller_init_application_modules(app_data_t *ad)
{
&nbsp;&nbsp;&nbsp;ad-&gt;vd = view_init();
&nbsp;&nbsp;&nbsp;if (!ad-&gt;vd)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Error handling
&nbsp;&nbsp;&nbsp;ad-&gt;md = model_init();
&nbsp;&nbsp;&nbsp;// Error handling
&nbsp;&nbsp;&nbsp;__controller_init_events(ad);

&nbsp;&nbsp;&nbsp;return true;
}

// Event handlers are stored in an Eina_List which is used to release allocated memory on 
// application terminate event
static void 
__controller_init_events(app_data_t *ad)
{
&nbsp;&nbsp;&nbsp;ad-&gt;app_events = eina_list_append(ad-&gt;app_events,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecore_event_handler_add(app_utils_get_event_type(EVENT_CONNECTION_REQUEST),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__controller_handle_connection_request_event, ad));
&nbsp;&nbsp;&nbsp;ad-&gt;app_events = eina_list_append(ad-&gt;app_events,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecore_event_handler_add(app_utils_get_event_type(EVENT_TRANSFER_IN_PROGRESS),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__controller_handle_transfer_in_progress_event, ad));
&nbsp;&nbsp;&nbsp;ad-&gt;app_events = eina_list_append(ad-&gt;app_events,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecore_event_handler_add(app_utils_get_event_type(EVENT_ACCEPT_BUTTON_CLICKED),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__controller_handle_accept_button_clicked_event, ad));
&nbsp;&nbsp;&nbsp;ad-&gt;app_events = eina_list_append(ad-&gt;app_events,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecore_event_handler_add(app_utils_get_event_type(EVENT_REJECT_BUTTON_CLICKED),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__controller_handle_reject_button_clicked_event, ad));
&nbsp;&nbsp;&nbsp;ad-&gt;app_events = eina_list_append(ad-&gt;app_events,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecore_event_handler_add(app_utils_get_event_type(EVENT_TRANSFER_STARTED),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__controller_handle_transfer_started_event, ad));
}
</pre>

<p>The event listeners described above are used to accept a file transfer, update the sending progress, and handle user interaction. When the application receives the connection request from another device, a custom event defined in the <span style="font-family: Courier New,Courier,monospace">app_utils.c</span> file is emitted.</p>
<p>To manage the callback functions:</p>
<ul>

<li>The following callback function is invoked when the state of the <strong>Accept</strong> button changes:
<pre class="prettyprint">
// Callback enables the Accept button
static Eina_Bool 
__controller_handle_connection_request_event(void *data, int type, void *event)
{
&nbsp;&nbsp;&nbsp;app_data_t *ad = (app_data_t *) data;
&nbsp;&nbsp;&nbsp;if (!ad)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Error handling
&nbsp;&nbsp;&nbsp;view_enable_accept_button(ad-&gt;vd);

&nbsp;&nbsp;&nbsp;return EINA_TRUE;
}
</pre>

<p>When the <strong>Accept</strong> button is enabled, you can press it to confirm the file transfer. The <span style="font-family: Courier New,Courier,monospace">__controller_handle_accept_button_clicked_event()</span> function changes the view state and starts the exchange process.</p>

<pre class="prettyprint">
static Eina_Bool 
__controller_handle_accept_button_clicked_event(void *data, int type, void *event)
{
&nbsp;&nbsp;&nbsp;app_data_t *ad = (app_data_t *) data;
&nbsp;&nbsp;&nbsp;bt_module_transfer_accept(ad-&gt;md);
&nbsp;&nbsp;&nbsp;view_disable_accept_button(ad-&gt;vd);
&nbsp;&nbsp;&nbsp;view_enable_reject_button(ad-&gt;vd);

&nbsp;&nbsp;&nbsp;return EINA_TRUE;
}
</pre>
</li>
<li>
<p>The <span style="font-family: Courier New,Courier,monospace">__controller_handle_transfer_started_event()</span> callback function is used to create an item in the received files list. It is called when a new file transfer starts.</p>
<pre class="prettyprint">
static Eina_Bool 
__controller_handle_transfer_started_event(void *data, int type, void *event)
{
&nbsp;&nbsp;&nbsp;Elm_Object_Item *new_item = NULL;
&nbsp;&nbsp;&nbsp;app_data_t *ad = (app_data_t *) data;
&nbsp;&nbsp;&nbsp;file_t *recv_file = (file_t *) event;
&nbsp;&nbsp;&nbsp;if (!ad || !recv_file)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Error handling
&nbsp;&nbsp;&nbsp;// Adding new item into the files list
&nbsp;&nbsp;&nbsp;new_item = view_append_new_file(ad-&gt;vd, recv_file-&gt;file_name, &amp;(recv_file-&gt;progress));
&nbsp;&nbsp;&nbsp;if (!new_item)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Error handling
&nbsp;&nbsp;&nbsp;// Bind the model with the view; new item is used later to update the sending progress
&nbsp;&nbsp;&nbsp;file_data_set(recv_file, (void *) new_item);

&nbsp;&nbsp;&nbsp;return EINA_TRUE;
}
</pre>
</li>
<li>
<p>The <span style="font-family: Courier New,Courier,monospace">__controller_handle_transfer_in_progress_event()</span> function is used to update the sending progress for each file. It is called when the <span style="font-family: Courier New,Courier,monospace">bt_module</span> emits the signal for the item update. It uses the data stored in the internal <span style="font-family: Courier New,Courier,monospace">file</span> object.</p>

<pre class="prettyprint">
static Eina_Bool 
__controller_handle_transfer_in_progress_event(void *data, int type, void *event)
{
&nbsp;&nbsp;&nbsp;app_data_t *ad = (app_data_t *) data;
&nbsp;&nbsp;&nbsp;file_t *file = (file_t *) event;
&nbsp;&nbsp;&nbsp;if (!file || !ad)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Error handling
&nbsp;&nbsp;&nbsp;view_update_progress((Elm_Object_Item *) file-&gt;data, (double) file-&gt;progress / 100.0);

&nbsp;&nbsp;&nbsp;return EINA_TRUE;
}
</pre>
</li>
<li>
<p>When the transfer starts, the application enables the <strong>Reject</strong> button. The user can stop the file exchange with it.</p>

<pre class="prettyprint">
static Eina_Bool 
__controller_handle_reject_button_clicked_event(void *data, int type, void *event)
{
&nbsp;&nbsp;&nbsp;app_data_t *ad = (app_data_t *) data;
&nbsp;&nbsp;&nbsp;if (!ad)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Error handling 
&nbsp;&nbsp;&nbsp;bt_module_transfer_reject(ad-&gt;md);
&nbsp;&nbsp;&nbsp;view_disable_reject_button(ad-&gt;vd);

&nbsp;&nbsp;&nbsp;return EINA_TRUE;
}
</pre>
</li>
</ul>

<h3>View</h3>
<p>The following figure illustrates the application views.</p>
<p class="figure">Figure: Files Sharing Server screens</p>
<p align="center"><img alt="Files Sharing Server screens" src="../images/files_sharing_server_help_text.png" /> <img alt="Files Sharing Server screens" src="../images/files_sharing_server_accept_button_enable.png" /> <img alt="Files Sharing Server screens" src="../images/files_sharing_server_received_list.png" /></p>
<p>To implement the application view:</p>
<ol>
<li>
<p>The view of the sample application is initialized by the controller module. It calls the <span style="font-family: Courier New,Courier,monospace">view_init()</span> function to initialize all view objects and data.</p>
<pre class="prettyprint">
view_data_t* 
view_init(void)
{
&nbsp;&nbsp;&nbsp;view_data_t *vd = NULL;
&nbsp;&nbsp;&nbsp;vd = (view_data_t *)malloc(sizeof(view_data_t));
&nbsp;&nbsp;&nbsp;if (!vd)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Error handling

&nbsp;&nbsp;&nbsp;// Create window, conformant and layout; code for those objects is generated by the SDK

&nbsp;&nbsp;&nbsp;if (!__view_create_files_list(vd))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Error handling

&nbsp;&nbsp;&nbsp;if (!__view_init_buttons(vd))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Error handling

&nbsp;&nbsp;&nbsp;// Show help text and disable buttons
&nbsp;&nbsp;&nbsp;view_show_help(vd);
&nbsp;&nbsp;&nbsp;view_disable_accept_button(vd);
&nbsp;&nbsp;&nbsp;view_disable_reject_button(vd);
&nbsp;&nbsp;&nbsp;evas_object_show(vd-&gt;win);

&nbsp;&nbsp;&nbsp;return vd;
}
</pre>
</li>
<li>
<p>The most important part of the view is the received files list. It shows all files obtained by the Bluetooth OPP protocol as well as the current status of the file transfer. To add a new file to the list, the <span style="font-family: Courier New,Courier,monospace">view_append_new_file()</span> function is used.</p>

<pre class="prettyprint">
Elm_Object_Item* 
view_append_new_file(view_data_t *vd, const char *file_name, int *progress)
{
&nbsp;&nbsp;&nbsp;struct _list_data_s *list_data_s = NULL;
&nbsp;&nbsp;&nbsp;Elm_Object_Item *new_item = NULL;

&nbsp;&nbsp;&nbsp;if (!vd || !file_name || !progress)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Error handling

&nbsp;&nbsp;&nbsp;list_data_s = (struct _list_data_s *)malloc(sizeof(struct _list_data_s));
&nbsp;&nbsp;&nbsp;if (!list_data_s)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Error handling

&nbsp;&nbsp;&nbsp;// List_data_s structure is used to pass one more parameter to the genlist 
&nbsp;&nbsp;&nbsp;// item creation callback
&nbsp;&nbsp;&nbsp;list_data_s-&gt;file_name = file_name;
&nbsp;&nbsp;&nbsp;list_data_s-&gt;progress = progress;

&nbsp;&nbsp;&nbsp;// Use the elm_gengrid API to add a new file
&nbsp;&nbsp;&nbsp;new_item = elm_genlist_item_append(vd-&gt;files_list, vd-&gt;gic,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(void *)list_data_s, NULL, 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELM_GENLIST_ITEM_NONE, 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NULL, NULL);

&nbsp;&nbsp;&nbsp;if (!new_item)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Error handling

&nbsp;&nbsp;&nbsp;return new_item;
}
</pre>

<p>The function described above calls the <span style="font-family: Courier New,Courier,monospace">elm_genlist_item_append()</span> function, which uses a callback from the genlist constructor to create the item&#39;s <span style="font-family: Courier New,Courier,monospace">Evas_Object</span>. The following example creates the item content.</p>

<pre class="prettyprint">
static Evas_Object*
__view_set_file_item_content_cb(void *data, Evas_Object *obj, const char *part)
{
&nbsp;&nbsp;&nbsp;if (!strncmp(part, FILE_LIST_ITEM_CONTENT, strlen(part)) &amp;&amp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strlen(part) == strlen(FILE_LIST_ITEM_CONTENT))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return __view_create_file_list_item(obj, data);

&nbsp;&nbsp;&nbsp;return NULL;
}

static Evas_Object* 
__view_create_file_list_item(Evas_Object *parent, struct _list_data_s *list_data_s)
{
&nbsp;&nbsp;&nbsp;Evas_Object *item_ly = NULL;
&nbsp;&nbsp;&nbsp;Evas_Object *progressbar = NULL;
&nbsp;&nbsp;&nbsp;char edj_path[PATH_MAX] = {0,};
&nbsp;&nbsp;&nbsp;char buf[64] = {0,};

&nbsp;&nbsp;&nbsp;if (!parent || !list_data_s || !list_data_s-&gt;file_name || !list_data_s-&gt;progress)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Error handling

&nbsp;&nbsp;&nbsp;// Create item layout
&nbsp;&nbsp;&nbsp;item_ly = elm_layout_add(parent);
&nbsp;&nbsp;&nbsp;if (!item_ly)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Error handling

&nbsp;&nbsp;&nbsp;// Get the path to the EDJE layout
&nbsp;&nbsp;&nbsp;app_utils_get_resource(EDJ_FILE, edj_path, (int)PATH_MAX);

&nbsp;&nbsp;&nbsp;// Create progressbar component
&nbsp;&nbsp;&nbsp;progressbar = elm_progressbar_add(parent);
&nbsp;&nbsp;&nbsp;if (!progressbar)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Error handling

&nbsp;&nbsp;&nbsp;// Set initial values
&nbsp;&nbsp;&nbsp;elm_progressbar_value_set(progressbar, (double)(*(list_data_s-&gt;progress)) / 100.0);
&nbsp;&nbsp;&nbsp;evas_object_size_hint_weight_set(progressbar, EVAS_HINT_EXPAND, EVAS_HINT_EXPAND);

&nbsp;&nbsp;&nbsp;// Show the file name and the sending progress
&nbsp;&nbsp;&nbsp;elm_object_part_text_set(item_ly, PART_ITEM_TITLE, list_data_s-&gt;file_name);
&nbsp;&nbsp;&nbsp;snprintf(buf, sizeof(buf), &quot;%d %%&quot;, *(list_data_s-&gt;progress));
&nbsp;&nbsp;&nbsp;elm_object_part_text_set(item_ly, PART_ITEM_PROGRESS, buf);

&nbsp;&nbsp;&nbsp;elm_object_part_content_set(item_ly, PART_ITEM_CONTENT, progressbar);
&nbsp;&nbsp;&nbsp;evas_object_show(item_ly);

&nbsp;&nbsp;&nbsp;return item_ly;
}
</pre>
</li>
<li>
<p>Each item consists of an <span style="font-family: Courier New,Courier,monospace">elm_progressbar</span> component, file name, and progress text. To update the content, the <span style="font-family: Courier New,Courier,monospace">view_update_progress()</span> function is used.</p>

<pre class="prettyprint">
void 
view_update_progress(Elm_Object_Item *it, double progress)
{
&nbsp;&nbsp;&nbsp;Evas_Object *item_ly = NULL;
&nbsp;&nbsp;&nbsp;Evas_Object *progressbar = NULL;
&nbsp;&nbsp;&nbsp;char buf[64] = {0,};

&nbsp;&nbsp;&nbsp;if (!it)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Error handling

&nbsp;&nbsp;&nbsp;item_ly = elm_object_item_part_content_get(it, FILE_LIST_ITEM_CONTENT);
&nbsp;&nbsp;&nbsp;if (!item_ly)
&nbsp;&nbsp;&nbsp;// It is not an error; if item_ly == NULL, it means 
&nbsp;&nbsp;&nbsp;// that it is not visible in the genlist so it must not be updated
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;

&nbsp;&nbsp;&nbsp;// Get the reference to the elm_progressbar component
&nbsp;&nbsp;&nbsp;progressbar = elm_object_part_content_get(item_ly, PART_ITEM_CONTENT);
&nbsp;&nbsp;&nbsp;// Save the progress in the buffer
&nbsp;&nbsp;&nbsp;snprintf(buf, sizeof(buf), &quot;%d %%&quot;, (int) (progress * 100));
&nbsp;&nbsp;&nbsp;// Update progress text
&nbsp;&nbsp;&nbsp;elm_object_part_text_set(item_ly, PART_ITEM_PROGRESS, buf);
&nbsp;&nbsp;&nbsp;// Update progressbar value
&nbsp;&nbsp;&nbsp;elm_progressbar_value_set(progressbar, progress);
}
</pre>
</li>
<li>
<p>File list items are deleted automatically by the <span style="font-family: Courier New,Courier,monospace">elm_genlist</span> API when the application is terminated. The delete function is also called during the list scroll when items are no longer visible. In both cases, additional data must be released.</p>

<pre class="prettyprint">
static void 
__view_del_file_item_cb(void *data, Evas_Object *obj)
{
&nbsp;&nbsp;&nbsp;struct _list_data_s *list_data_s = (struct _list_data_s *)data;
&nbsp;&nbsp;&nbsp;if (!list_data_s)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Error handling

&nbsp;&nbsp;&nbsp;free(list_data_s);
}
</pre>
</li>
</ol>

<h3>Model</h3>

<p>The application model consists of 3 sub-modules: model, file, and the Bluetooth module. The main tasks are presented in the following figure.</p>
<p class="figure">Figure: Model tasks</p>
<p align="center"><img alt="Model tasks" src="../images/files_sharing_server_model_tasks.png"/></p>

<p>To create the application model:</p>

<ol>
<li>
<p>The model data is represented by the <span style="font-family: Courier New,Courier,monospace">model_data_t</span> structure, which is allocated in the <span style="font-family: Courier New,Courier,monospace">model_init()</span> function, called by the controller when the application is created.</p>

<pre class="prettyprint">
struct 
_model_data_t 
{
&nbsp;&nbsp;&nbsp;Eina_List *files_list;
&nbsp;&nbsp;&nbsp;int transfer_id;
};
typedef struct _model_data_t model_data_t;

extern model_data_t* 
model_init(void)
{
&nbsp;&nbsp;&nbsp;model_data_t *md = NULL;
&nbsp;&nbsp;&nbsp;md = (model_data_t *)malloc(sizeof(model_data_t));
&nbsp;&nbsp;&nbsp;md-&gt;files_list = NULL;

&nbsp;&nbsp;&nbsp;if (!bt_module_init())
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Error handling

&nbsp;&nbsp;&nbsp;return md;
}
</pre>

<p>The model object destructor is called on the <span style="font-family: Courier New,Courier,monospace">app_terminate()</span> function by the constructor and releases all allocated data.</p>
<pre class="prettyprint">
extern void 
model_deinit(model_data_t *md)
{
&nbsp;&nbsp;&nbsp;file_t *file = NULL;

&nbsp;&nbsp;&nbsp;if (!md || !md-&gt;files_list)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Error handling

&nbsp;&nbsp;&nbsp;EINA_LIST_FREE (md-&gt;files_list, file)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file_delete(file);

&nbsp;&nbsp;&nbsp;free(md);
&nbsp;&nbsp;&nbsp;bt_module_deinit();
}
</pre>
</li>
<li>
<p>Initialize Bluetooth:</p>
<pre class="prettyprint">
bool 
bt_module_init(void)
{
&nbsp;&nbsp;&nbsp;int ret = BT_ERROR_NONE;
&nbsp;&nbsp;&nbsp;char *directory = NULL;

&nbsp;&nbsp;&nbsp;// Set storage directory for received files
&nbsp;&nbsp;&nbsp;storage_get_directory(0, STORAGE_DIRECTORY_DOWNLOADS, &amp;directory);
&nbsp;&nbsp;&nbsp;if (!directory)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Error handling

&nbsp;&nbsp;&nbsp;// Initialize Bluetooth
&nbsp;&nbsp;&nbsp;ret = bt_initialize();
&nbsp;&nbsp;&nbsp;if (ret != BT_ERROR_NONE)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Error handling

&nbsp;&nbsp;&nbsp;// Initialize the Bluetooth OPP server and set callbacks invoked when 
&nbsp;&nbsp;&nbsp;// the connection is requested
&nbsp;&nbsp;&nbsp;ret = bt_opp_server_initialize_by_connection_request(directory, 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__bt_connection_request_cb, 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NULL);
&nbsp;&nbsp;&nbsp;if (ret != BT_ERROR_NONE)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Error handling

&nbsp;&nbsp;&nbsp;free(directory);

&nbsp;&nbsp;&nbsp;return true;
}
</pre>

<p>All initialized modules must be released when they are no longer needed. In case of this sample application, the Bluetooth module is deinitialized on the <span style="font-family: Courier New,Courier,monospace">app_terminate</span> event.</p>

<pre class="prettyprint">
void 
bt_module_deinit(void)
{
&nbsp;&nbsp;&nbsp;int ret = BT_ERROR_NONE;

&nbsp;&nbsp;&nbsp;ret = bt_opp_server_deinitialize();
&nbsp;&nbsp;&nbsp;if (ret != BT_ERROR_NONE)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Error handling

&nbsp;&nbsp;&nbsp;ret = bt_deinitialize();
&nbsp;&nbsp;&nbsp;if (ret != BT_ERROR_NONE)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Error handling
}
</pre>
</li>
<li>
<p>If another device starts to send files using the Bluetooth OPP protocol, a request callback is invoked.</p>
<p>In this sample application, the Ecore event mechanism is used to inform the controller about actions from other modules. This approach was chosen to avoid static data structures declared in each module.</p>

<pre class="prettyprint">
static void 
__bt_connection_request_cb(const char *remote_addr, void *data)
{
&nbsp;&nbsp;&nbsp;ecore_event_add(app_utils_get_event_type(EVENT_CONNECTION_REQUEST),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NULL, NULL, NULL);
}
</pre>
</li>
<li>
<p>After receiving a request event, the controller changes the state of the view to enable the <strong>Accept</strong> button.</p>
<p>When the user taps it, the <span style="font-family: Courier New,Courier,monospace">bt_module_transfer_accept()</span> function is called. It accepts the connection and starts the file transfer. It is also used to set callback functions which inform the application about the progress changes and transfer finished events.</p>

<pre class="prettyprint">
void 
bt_module_transfer_accept(model_data_t *md)
{
&nbsp;&nbsp;&nbsp;int ret = BT_ERROR_NONE;

&nbsp;&nbsp;&nbsp;if (!md)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Error handling

&nbsp;&nbsp;&nbsp;ret = bt_opp_server_accept(__bt_transfer_progress_cb, __bt_transfer_finished_cb,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NULL, md, &amp;(md-&gt;transfer_id));

&nbsp;&nbsp;&nbsp;if (ret != BT_ERROR_NONE)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Error handling
}
</pre>
</li>
<li>
<p>The <span style="font-family: Courier New,Courier,monospace">__bt_transfer_progress_cb()</span> function is used to update the received file progress and distinguish the new file transfer.</p>
<p>For that purpose, the <span style="font-family: Courier New,Courier,monospace">transfer_in_progress</span> flag is declared in the static memory. It is reset by the <span style="font-family: Courier New,Courier,monospace">__bt_transfer_finished_cb()</span> callback function.</p>

<pre class="prettyprint">
static void 
__bt_transfer_progress_cb(const char *file, long long size, int percent, void *user_data)
{
&nbsp;&nbsp;&nbsp;model_data_t *md = (model_data_t *)user_data;
&nbsp;&nbsp;&nbsp;static file_t *recv_file = NULL;

&nbsp;&nbsp;&nbsp;if (!md)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Error handling

&nbsp;&nbsp;&nbsp;// Receive a new file; the EVENT_TRANSFER_STARTED is emitted 
&nbsp;&nbsp;&nbsp;// and it is handled by the controller to add a new file item into the files list
&nbsp;&nbsp;&nbsp;if (!transfer_in_progress) 
&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Create a new file object
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;recv_file = file_create(md, strdup(file), NULL);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Pass the created file to the controller module
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// New genlist item is created based on the file
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecore_event_add(app_utils_get_event_type(EVENT_TRANSFER_STARTED), 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;recv_file, __bt_transfer_started_end_cb, NULL);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Change the flag to true
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// It is reset when the transfer of the file is completed
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transfer_in_progress = true;
&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;// Update the progress of the received file
&nbsp;&nbsp;&nbsp;file_update_progress(recv_file, percent);
&nbsp;&nbsp;&nbsp;// Pass the received file to the controller
&nbsp;&nbsp;&nbsp;// It is used to update the progressbar component for a  
&nbsp;&nbsp;&nbsp;// specific file in the received files list
&nbsp;&nbsp;&nbsp;ecore_event_add(app_utils_get_event_type(EVENT_TRANSFER_IN_PROGRESS), 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;recv_file, __bt_transfer_in_progress_end_cb, NULL);
}
</pre>
</li>
<li>
<p>The <span style="font-family: Courier New,Courier,monospace">__bt_transfer_finished_cb()</span> callback is used to change the value of the <span style="font-family: Courier New,Courier,monospace">transfer_in_progress</span> flag.</p>

<pre class="prettyprint">
static void 
__bt_transfer_finished_cb(int result, const char *file, long long size, void *user_data)
{
&nbsp;&nbsp;&nbsp;transfer_in_progress = false;
}
</pre>
</li>
</ol>
<p>All helper functions used in the sample application are implemented in the <span style="font-family: Courier New,Courier,monospace">app_utils.c</span> file. The most important function in this module initializes new Ecore callbacks used by the controller.</p>

<pre class="prettyprint">
typedef enum 
{
&nbsp;&nbsp;&nbsp;EVENT_CONNECTION_REQUEST = 0,
&nbsp;&nbsp;&nbsp;EVENT_TRANSFER_IN_PROGRESS,
&nbsp;&nbsp;&nbsp;EVENT_ACCEPT_BUTTON_CLICKED,
&nbsp;&nbsp;&nbsp;EVENT_REJECT_BUTTON_CLICKED,
&nbsp;&nbsp;&nbsp;EVENT_TRANSFER_STARTED,
} event_type_t;

extern int 
app_utils_get_event_type(event_type_t event)
{
&nbsp;&nbsp;&nbsp;int i = 0;

&nbsp;&nbsp;&nbsp;if (!initialized) 
&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;initialized = true;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (i = 0; i &lt; APP_EVENTS_COUNT; i++)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arr_custom_events[i] = ecore_event_type_new();
&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;return arr_custom_events[event];
}
</pre>


<script type="text/javascript" src="../scripts/jquery.zclip.min.js"></script>
<script type="text/javascript" src="../scripts/showhide.js"></script>
</div></div></div>

<a class="top sms" href="#"><img src="../images/btn_top.gif" alt="Go to top" /></a>

<div id="footer">
<p class="footer">Except as noted, this content - excluding the Code Examples - is licensed under <a href="http://creativecommons.org/licenses/by/3.0/legalcode" target="_blank">Creative Commons Attribution 3.0</a> and all of the Code Examples contained herein are licensed under <a href="https://www.tizen.org/bsd-3-clause-license" target="_blank">BSD-3-Clause</a>.<br/>For details, see the <a href="https://www.tizen.org/content-license" target="_blank">Content License</a>.</p>
</div>

<script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-25976949-1']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>

</body>
</html>
